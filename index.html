<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Arizona Prime — Подать заявление</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=Inter:wght@400;500&display=swap" rel="stylesheet">
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/react-router-dom@6/dist/umd/react-router-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    /* Arizona Prime — iOS 26 Liquid Glass, минимализм */
    :root {
      --glass: rgba(255, 255, 255, 0.12);
      --glass-strong: rgba(255, 255, 255, 0.18);
      --glass-border: rgba(255, 255, 255, 0.2);
      --glass-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
      --blur: 24px;
      --radius: 20px;
      --radius-sm: 14px;
      --radius-pill: 999px;
      --accent: #0a84ff;
      --accent-hover: #409cff;
      --text: rgba(255, 255, 255, 0.95);
      --text-muted: rgba(255, 255, 255, 0.65);
      --bg: #000;
      --bg-gradient: radial-gradient(ellipse 80% 50% at 50% -20%, rgba(120, 119, 198, 0.15), transparent),
                     radial-gradient(ellipse 60% 40% at 80% 50%, rgba(10, 132, 255, 0.08), transparent);
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg);
      background-image: var(--bg-gradient);
      color: var(--text);
      min-height: 100vh;
      -webkit-font-smoothing: antialiased;
    }
    .font-geo { font-family: 'Outfit', -apple-system, sans-serif; font-weight: 600; letter-spacing: -0.02em; }
    .glass {
      background: var(--glass);
      backdrop-filter: blur(var(--blur));
      -webkit-backdrop-filter: blur(var(--blur));
      border: 1px solid var(--glass-border);
      border-radius: var(--radius);
      box-shadow: var(--glass-shadow);
    }
    .glass-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 14px 28px;
      border-radius: var(--radius-sm);
      border: 1px solid var(--glass-border);
      background: var(--glass);
      backdrop-filter: blur(var(--blur));
      -webkit-backdrop-filter: blur(var(--blur));
      color: var(--text);
      font-family: inherit;
      font-size: 1rem;
      font-weight: 500;
      cursor: pointer;
      transition: transform 0.15s, background 0.2s, border-color 0.2s;
      text-decoration: none;
    }
    .glass-btn:hover {
      background: var(--glass-strong);
      border-color: rgba(255, 255, 255, 0.3);
      transform: scale(1.02);
    }
    .glass-btn.primary { background: var(--accent); border-color: transparent; color: #fff; }
    .glass-btn.primary:hover { background: var(--accent-hover); }
    input, select, textarea {
      width: 100%;
      padding: 14px 18px;
      border-radius: var(--radius-sm);
      border: 1px solid var(--glass-border);
      background: rgba(255, 255, 255, 0.06);
      color: var(--text);
      font-family: inherit;
      font-size: 1rem;
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    input::placeholder, textarea::placeholder { color: var(--text-muted); }
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(10, 132, 255, 0.25);
    }
    label { display: block; margin-bottom: 8px; font-size: 0.9rem; color: var(--text-muted); }
    .form-group { margin-bottom: 20px; }
    .public-layout {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 24px 20px 80px;
    }
    .nav-top { display: flex; flex-wrap: wrap; gap: 12px; justify-content: center; margin-bottom: 48px; }
    .nav-top .glass-btn.active { background: var(--glass-strong); border-color: var(--accent); color: var(--accent); }
    .hero { text-align: center; max-width: 640px; margin: 0 auto 40px; }
    .hero-title { font-size: clamp(2.5rem, 6vw, 3.5rem); margin-bottom: 20px; line-height: 1.1; }
    .hero-sub { font-size: 1.05rem; line-height: 1.6; color: var(--text-muted); margin-bottom: 36px; }
    .cta-wrap { display: flex; justify-content: center; }
    .admin-entry {
      position: fixed;
      bottom: 16px;
      right: 16px;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.1);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-muted);
      font-size: 18px;
      text-decoration: none;
      transition: background 0.2s, color 0.2s;
      z-index: 100;
    }
    .admin-entry:hover { background: rgba(255,255,255,0.12); color: var(--text); }
    .page-content { width: 100%; max-width: 560px; margin: 0 auto; }
    .page-title { font-family: 'Outfit', sans-serif; font-size: 1.75rem; margin-bottom: 24px; text-align: center; }
    .leadership-grid { display: grid; gap: 20px; margin-top: 24px; }
    .leadership-card {
      padding: 24px;
      display: flex;
      gap: 20px;
      align-items: flex-start;
    }
    .leadership-avatar {
      width: 80px;
      height: 80px;
      border-radius: var(--radius-sm);
      background: rgba(255,255,255,0.08);
      object-fit: cover;
      flex-shrink: 0;
    }
    .leadership-info h3 { font-family: 'Outfit', sans-serif; font-size: 1.15rem; margin-bottom: 4px; }
    .leadership-position { font-size: 0.9rem; color: var(--accent); margin-bottom: 8px; }
    .leadership-bio { font-size: 0.95rem; color: var(--text-muted); line-height: 1.5; }
    .admin-layout { min-height: 100vh; padding: 24px; max-width: 900px; margin: 0 auto; }
    .admin-tabs { display: flex; gap: 8px; margin-bottom: 24px; }
    .admin-tabs .glass-btn.active { background: var(--glass-strong); border-color: var(--accent); color: var(--accent); }
    .table-wrap {
      overflow-x: auto;
      border-radius: var(--radius-sm);
      border: 1px solid var(--glass-border);
      background: var(--glass);
      backdrop-filter: blur(var(--blur));
    }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 14px 18px; text-align: left; border-bottom: 1px solid rgba(255,255,255,0.06); }
    th { font-weight: 600; font-size: 0.8rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.04em; }
    tr:last-child td { border-bottom: none; }
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.6);
      backdrop-filter: blur(8px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 20px;
    }
    .modal {
      background: rgba(28, 28, 30, 0.95);
      backdrop-filter: blur(var(--blur));
      border: 1px solid var(--glass-border);
      border-radius: var(--radius);
      padding: 28px;
      max-width: 440px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
    }
    .modal h2 { margin-bottom: 20px; font-size: 1.25rem; }
    .btn-danger { background: rgba(255, 59, 48, 0.9); border: none; color: #fff; }
    .btn-danger:hover { background: rgb(255, 59, 48); }
    .error-msg { color: #ff6b6b; font-size: 0.9rem; margin-top: 8px; }
    .success-msg { color: #34c759; font-size: 0.9rem; margin-top: 8px; }
    .avatar-placeholder {
      width: 80px;
      height: 80px;
      border-radius: var(--radius-sm);
      background: rgba(255,255,255,0.08);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-muted);
      font-size: 1.5rem;
      flex-shrink: 0;
    }
    a { color: var(--accent); text-decoration: none; }
    a:hover { text-decoration: underline; }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel" data-type="module">
    const { useState, useEffect, createContext, useContext } = React;
    const { createRoot } = ReactDOM;
    const { HashRouter, Routes, Route, Navigate, Link, Outlet, useLocation, useNavigate, NavLink } = ReactRouterDOM;

    // --- API ---
    const API = '/api';
    function getToken() { return localStorage.getItem('token'); }
    async function request(path, options = {}) {
      const token = getToken();
      const headers = { 'Content-Type': 'application/json', ...(token && { Authorization: `Bearer ${token}` }), ...options.headers };
      const res = await fetch(`${API}${path}`, { ...options, headers });
      const data = await res.json().catch(() => ({}));
      if (!res.ok) throw new Error(data.error || res.statusText || 'Ошибка запроса');
      return data;
    }
    const authApi = {
      login: (nickname, password) => request('/auth/login', { method: 'POST', body: JSON.stringify({ nickname, password }) }),
      register: (nickname, password) => request('/auth/register', { method: 'POST', body: JSON.stringify({ nickname, password }) }),
      createUser: (nickname, password) => request('/auth/create', { method: 'POST', body: JSON.stringify({ nickname, password }) }),
    };
    function avatarUrl(filename) { return filename ? `/uploads/avatars/${filename}` : null; }
    const usersApi = {
      me: () => request('/users/me'),
      get: (id) => request(`/users/${id}`),
      listAll: () => request('/users/list/all'),
      updateMe: (data) => request('/users/me', { method: 'PATCH', body: JSON.stringify(data) }),
      uploadAvatar: (file) => {
        const token = localStorage.getItem('token');
        const form = new FormData();
        form.append('avatar', file);
        return fetch(`/api/users/me/avatar`, { method: 'POST', headers: token ? { Authorization: `Bearer ${token}` } : {}, body: form })
          .then((r) => r.json()).then((data) => { if (data.error) throw new Error(data.error); return data; });
      },
      updateNickname: (id, nickname) => request(`/users/${id}/nickname`, { method: 'PATCH', body: JSON.stringify({ nickname }) }),
      updateProfile: (id, data) => request(`/users/${id}/profile`, { method: 'PATCH', body: JSON.stringify(data) }),
    };
    const staffApi = {
      list: () => request('/staff'),
      add: (data) => request('/staff', { method: 'POST', body: JSON.stringify(data) }),
      update: (id, data) => request(`/staff/${id}`, { method: 'PATCH', body: JSON.stringify(data) }),
      remove: (id) => request(`/staff/${id}`, { method: 'DELETE' }),
    };
    const applicationsApi = {
      submit: (data) => fetch('/api/applications', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) })
        .then((r) => r.json()).then((d) => { if (d.error) throw new Error(d.error || d.errors?.[0]?.msg); return d; }),
      list: () => request('/applications'),
    };
    const leadershipApi = {
      list: () => fetch('/api/leadership').then((r) => r.json()),
      add: (data) => request('/leadership', { method: 'POST', body: JSON.stringify(data) }),
      update: (id, data) => request(`/leadership/${id}`, { method: 'PATCH', body: JSON.stringify(data) }),
      delete: (id) => request(`/leadership/${id}`, { method: 'DELETE' }),
      uploadAvatar: (id, file) => {
        const token = localStorage.getItem('token');
        const form = new FormData();
        form.append('avatar', file);
        return fetch(`/api/leadership/${id}/avatar`, { method: 'POST', headers: token ? { Authorization: `Bearer ${token}` } : {}, body: form })
          .then((r) => r.json()).then((d) => { if (d.error) throw new Error(d.error); return d; });
      },
    };
    function leadershipAvatarUrl(filename) { return filename ? `/uploads/leadership/${filename}` : null; }

    // --- AuthContext ---
    const AuthContext = createContext(null);
    function AuthProvider({ children }) {
      const [user, setUser] = useState(null);
      const [loading, setLoading] = useState(true);
      useEffect(() => {
        const token = localStorage.getItem('token');
        if (!token) { setLoading(false); return; }
        usersApi.me()
          .then((data) => setUser({ id: data.id, nickname: data.nickname, role: data.role, avatar_emoji: data.avatar_emoji, staff: data.staff }))
          .catch(() => localStorage.removeItem('token'))
          .finally(() => setLoading(false));
      }, []);
      const login = (token, userData) => { localStorage.setItem('token', token); setUser(userData); };
      const logout = () => { localStorage.removeItem('token'); setUser(null); };
      const refreshMe = () => usersApi.me().then((data) => { setUser((prev) => ({ ...prev, nickname: data.nickname, role: data.role, avatar_path: data.avatar_path, staff: data.staff })); return data; });
      const isCuratorOrAdmin = user && (user.role === 'curator' || user.role === 'admin');
      const isAdmin = user && user.role === 'admin';
      return <AuthContext.Provider value={{ user, loading, login, logout, refreshMe, isCuratorOrAdmin, isAdmin }}>{children}</AuthContext.Provider>;
    }
    function useAuth() { const ctx = useContext(AuthContext); if (!ctx) throw new Error('useAuth only inside AuthProvider'); return ctx; }

    // --- Components ---
    function PublicLayout() {
      const location = useLocation();
      const is = (path) => location.pathname === path;
      const isHome = location.pathname === '/';
      return (
        <div className="public-layout">
          <nav className="nav-top">
            <Link to="/" className={`glass-btn ${isHome ? 'active' : ''}`}>Главная</Link>
            <Link to="/anketa" className={`glass-btn ${is('/anketa') ? 'active' : ''}`}>Анкета</Link>
            <Link to="/company" className={`glass-btn ${is('/company') ? 'active' : ''}`}>О компании Arizona Prime</Link>
            <Link to="/leadership" className={`glass-btn ${is('/leadership') ? 'active' : ''}`}>Руководящий состав</Link>
          </nav>
          <Outlet />
          <Link to="/admin" className="admin-entry" title="Вход для администратора" aria-label="Админ">&#x2699;</Link>
        </div>
      );
    }

    function Home() {
      return (
        <>
          <section className="hero">
            <h1 className="hero-title font-geo">ARIZONA PRIME</h1>
            <p className="hero-sub">
              Мы тщательно поддерживаем высокий уровень Role‑Play на всех проектах Arizona Games — здесь каждый персонаж оживает, а сюжеты развиваются естественно. Чего ты ждёшь? Присоединяйся к нашему активному сообществу, создавай уникальную историю и погружайся в мир, где твои решения имеют значение!
            </p>
            <div className="cta-wrap">
              <Link to="/anketa" className="glass-btn primary">Подать заявление</Link>
            </div>
          </section>
        </>
      );
    }

    function Anketa() {
      const [form, setForm] = useState({ game_nickname: '', server_position: '', discord: '', vk_url: '', forum_url: '' });
      const [loading, setLoading] = useState(false);
      const [error, setError] = useState('');
      const [success, setSuccess] = useState(false);
      const handleChange = (e) => { setForm({ ...form, [e.target.name]: e.target.value }); setError(''); };
      const handleSubmit = async (e) => {
        e.preventDefault();
        setError('');
        setSuccess(false);
        const position = form.server_position.trim() || '—';
        setLoading(true);
        try {
          await applicationsApi.submit({
            game_nickname: form.game_nickname.trim(),
            server_position: position,
            discord: form.discord.trim(),
            vk_url: form.vk_url.trim(),
            forum_url: form.forum_url.trim(),
          });
          setSuccess(true);
          setForm({ game_nickname: '', server_position: '', discord: '', vk_url: '', forum_url: '' });
        } catch (err) {
          setError(err.message || 'Ошибка отправки');
        } finally { setLoading(false); }
      };
      return (
        <div className="page-content">
          <h2 className="page-title font-geo">Анкета</h2>
          <form onSubmit={handleSubmit} className="glass" style={{ padding: '28px' }}>
            <div className="form-group">
              <label>Игровой никнейм *</label>
              <input name="game_nickname" value={form.game_nickname} onChange={handleChange} placeholder="Ваш ник в игре" required />
            </div>
            <div className="form-group">
              <label>Должность на сервере *</label>
              <input name="server_position" value={form.server_position} onChange={handleChange} placeholder="— если нет; для админа — должность; для лидера/зама — должность и название организации" />
              <small style={{ color: 'var(--text-muted)', fontSize: '0.85rem', marginTop: '6px', display: 'block' }}>
                При отсутствии укажите прочерк (—). Администратор — свою должность. Лидер/заместитель организации — должность и название организации.
              </small>
            </div>
            <div className="form-group">
              <label>Discord</label>
              <input name="discord" value={form.discord} onChange={handleChange} placeholder="Ник или ссылка" />
            </div>
            <div className="form-group">
              <label>ВКонтакте</label>
              <input name="vk_url" value={form.vk_url} onChange={handleChange} placeholder="Ссылка на страницу (ID можно узнать на regvk.com)" type="url" />
            </div>
            <div className="form-group">
              <label>Форумный аккаунт</label>
              <input name="forum_url" value={form.forum_url} onChange={handleChange} placeholder="Ссылка на профиль на форуме" type="url" />
            </div>
            {error && <p className="error-msg">{error}</p>}
            {success && <p className="success-msg">Заявление успешно отправлено.</p>}
            <button type="submit" className="glass-btn primary" style={{ width: '100%', marginTop: '8px' }} disabled={loading}>
              {loading ? 'Отправка…' : 'Отправить заявление'}
            </button>
          </form>
        </div>
      );
    }

    function Company() {
      return (
        <div className="page-content">
          <h2 className="page-title font-geo">О компании Arizona Prime</h2>
          <div className="glass" style={{ padding: '28px' }}>
            <p style={{ marginBottom: '16px', lineHeight: '1.65', color: 'var(--text-muted)' }}>
              <strong style={{ color: 'var(--text)' }}>Arizona Prime</strong> — часть экосистемы Arizona Games, отвечающая за качество и развитие ролевых проектов. Мы создаём условия, в которых каждый игрок может проживать убедительные истории и влиять на мир.
            </p>
            <p style={{ marginBottom: '16px', lineHeight: '1.65', color: 'var(--text-muted)' }}>
              На наших серверах действуют единые стандарты Role‑Play: от проработки персонажей до логики сюжетов. Команда следит за атмосферой и правилами, чтобы сохранять баланс между свободой и порядком.
            </p>
            <p style={{ marginBottom: '16px', lineHeight: '1.65', color: 'var(--text-muted)' }}>
              Если ты хочешь присоединиться к администрации, курировать проекты или просто подать заявку — заполни анкету через кнопку «Подать заявление» на главной странице. Мы рассматриваем каждую заявку и связываемся с кандидатами по указанным контактам.
            </p>
            <p style={{ lineHeight: '1.65', color: 'var(--text-muted)' }}>
              Добро пожаловать в Arizona Prime — место, где твои решения имеют значение.
            </p>
          </div>
        </div>
      );
    }

    function Leadership() {
      const [list, setList] = useState([]);
      const [loading, setLoading] = useState(true);
      useEffect(() => {
        leadershipApi.list().then(setList).catch(() => setList([])).finally(() => setLoading(false));
      }, []);
      if (loading) return <div className="page-content"><h2 className="page-title font-geo">Руководящий состав</h2><p style={{ color: 'var(--text-muted)' }}>Загрузка…</p></div>;
      return (
        <div className="page-content">
          <h2 className="page-title font-geo">Руководящий состав Arizona Prime</h2>
          <div className="leadership-grid">
            {list.length === 0 ? <p style={{ color: 'var(--text-muted)' }}>Список пока пуст.</p> : list.map((person) => (
              <article key={person.id} className="glass leadership-card">
                {person.avatar_path ? <img src={leadershipAvatarUrl(person.avatar_path)} alt={person.name} className="leadership-avatar" /> : <div className="avatar-placeholder">?</div>}
                <div className="leadership-info">
                  <h3>{person.name}</h3>
                  {person.position && <p className="leadership-position">{person.position}</p>}
                  {person.bio && <p className="leadership-bio">{person.bio}</p>}
                </div>
              </article>
            ))}
          </div>
        </div>
      );
    }

    function AdminLogin() {
      const [nickname, setNickname] = useState('');
      const [password, setPassword] = useState('');
      const [error, setError] = useState('');
      const [loading, setLoading] = useState(false);
      const { login } = useAuth();
      const navigate = useNavigate();
      const handleSubmit = async (e) => {
        e.preventDefault();
        setError('');
        setLoading(true);
        try {
          const data = await authApi.login(nickname, password);
          login(data.token, { id: data.userId, nickname: data.nickname, role: data.role, avatar_path: data.avatar_path });
          if (data.role === 'admin') navigate('/admin');
          else setError('Доступ только для администратора');
        } catch (err) { setError(err.message || 'Ошибка входа'); }
        finally { setLoading(false); }
      };
      return (
        <div className="public-layout">
          <div className="glass" style={{ maxWidth: 400, padding: 32, marginTop: 40 }}>
            <h1 className="font-geo" style={{ marginBottom: 24, textAlign: 'center', fontSize: '1.5rem' }}>Вход для администратора</h1>
            <form onSubmit={handleSubmit}>
              <div className="form-group">
                <label>Логин</label>
                <input type="text" value={nickname} onChange={(e) => setNickname(e.target.value)} placeholder="Логин" required autoComplete="username" />
              </div>
              <div className="form-group">
                <label>Пароль</label>
                <input type="password" value={password} onChange={(e) => setPassword(e.target.value)} placeholder="Пароль" required autoComplete="current-password" />
              </div>
              {error && <p className="error-msg">{error}</p>}
              <button type="submit" className="glass-btn primary" style={{ width: '100%', marginTop: 8 }} disabled={loading}>{loading ? 'Вход…' : 'Войти'}</button>
            </form>
            <p style={{ textAlign: 'center', marginTop: 20 }}><Link to="/" className="glass-btn" style={{ display: 'inline-block' }}>На главную</Link></p>
          </div>
        </div>
      );
    }

    function AdminDashboard() {
      const { user, isAdmin, logout } = useAuth();
      const [tab, setTab] = useState('applications');
      const [applications, setApplications] = useState([]);
      const [leadership, setLeadership] = useState([]);
      const [loading, setLoading] = useState(true);
      const [modal, setModal] = useState(null);
      const [form, setForm] = useState({ name: '', position: '', bio: '', sort_order: 0 });
      const [error, setError] = useState('');
      const [saving, setSaving] = useState(false);
      const loadApplications = () => applicationsApi.list().then(setApplications).catch(() => setApplications([]));
      const loadLeadership = () => leadershipApi.list().then(setLeadership).catch(() => setLeadership([]));
      useEffect(() => {
        if (!isAdmin) return;
        setLoading(true);
        Promise.all([applicationsApi.list().then(setApplications).catch(() => []), leadershipApi.list().then(setLeadership).catch(() => [])]).finally(() => setLoading(false));
      }, [isAdmin]);
      useEffect(() => { if (tab === 'applications') loadApplications(); if (tab === 'leadership') loadLeadership(); }, [tab]);
      const openAddLeadership = () => { setForm({ name: '', position: '', bio: '', sort_order: leadership.length }); setModal('add'); setError(''); };
      const openEditLeadership = (person) => { setForm({ id: person.id, name: person.name, position: person.position || '', bio: person.bio || '', sort_order: person.sort_order ?? 0 }); setModal('edit'); setError(''); };
      const saveLeadership = async () => {
        setError('');
        setSaving(true);
        try {
          if (modal === 'add') {
            await leadershipApi.add({ name: form.name, position: form.position, bio: form.bio, sort_order: form.sort_order });
            loadLeadership();
            setModal(null);
          } else {
            await leadershipApi.update(form.id, { name: form.name, position: form.position, bio: form.bio, sort_order: form.sort_order });
            loadLeadership();
            setModal(null);
          }
        } catch (err) { setError(err.message || 'Ошибка сохранения'); }
        finally { setSaving(false); }
      };
      const deleteLeadership = async (id) => {
        if (!confirm('Удалить этого сотрудника?')) return;
        try { await leadershipApi.delete(id); loadLeadership(); setModal(null); } catch (err) { setError(err.message); }
      };
      const uploadAvatar = async (id, file) => {
        if (!file) return;
        try { await leadershipApi.uploadAvatar(id, file); loadLeadership(); } catch (err) { setError(err.message); }
      };
      if (!isAdmin) return (
        <div className="admin-layout">
          <p className="error-msg">Недостаточно прав. Только администратор может открыть эту страницу.</p>
          <button type="button" className="glass-btn" onClick={logout}>Выйти</button>
          <a href="#/" className="glass-btn" style={{ marginLeft: 8 }}>На главную</a>
        </div>
      );
      return (
        <div className="admin-layout">
          <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 24, flexWrap: 'wrap', gap: 12 }}>
            <h1 className="font-geo" style={{ fontSize: '1.5rem' }}>Панель администратора</h1>
            <div style={{ display: 'flex', gap: 8 }}>
              <span style={{ color: 'var(--text-muted)', fontSize: '0.9rem' }}>{user?.nickname}</span>
              <button type="button" className="glass-btn" onClick={logout}>Выйти</button>
              <a href="#/">На сайт</a>
            </div>
          </div>
          <div className="admin-tabs">
            <button type="button" className={`glass-btn ${tab === 'applications' ? 'active' : ''}`} onClick={() => setTab('applications')}>Заявления</button>
            <button type="button" className={`glass-btn ${tab === 'leadership' ? 'active' : ''}`} onClick={() => setTab('leadership')}>Руководящий состав</button>
          </div>
          {loading ? <p style={{ color: 'var(--text-muted)' }}>Загрузка…</p> : tab === 'applications' ? (
            <div className="table-wrap">
              <table>
                <thead>
                  <tr><th>Никнейм</th><th>Должность</th><th>Discord</th><th>ВК</th><th>Форум</th><th>Дата</th></tr>
                </thead>
                <tbody>
                  {applications.length === 0 ? <tr><td colSpan={6} style={{ color: 'var(--text-muted)' }}>Нет заявлений</td></tr> : applications.map((a) => (
                    <tr key={a.id}>
                      <td>{a.game_nickname}</td>
                      <td>{a.server_position}</td>
                      <td>{a.discord || '—'}</td>
                      <td>{a.vk_url ? <a href={a.vk_url} target="_blank" rel="noopener noreferrer">Ссылка</a> : '—'}</td>
                      <td>{a.forum_url ? <a href={a.forum_url} target="_blank" rel="noopener noreferrer">Ссылка</a> : '—'}</td>
                      <td>{new Date(a.created_at).toLocaleDateString('ru')}</td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          ) : (
            <>
              <button type="button" className="glass-btn primary" onClick={openAddLeadership} style={{ marginBottom: 20 }}>Добавить в руководство</button>
              <div className="leadership-grid">
                {leadership.map((person) => (
                  <div key={person.id} className="glass leadership-card" style={{ justifyContent: 'space-between', alignItems: 'center' }}>
                    <div style={{ display: 'flex', gap: 20, alignItems: 'center', flex: 1 }}>
                      <label style={{ cursor: 'pointer' }}>
                        {person.avatar_path ? <img src={leadershipAvatarUrl(person.avatar_path)} alt="" className="leadership-avatar" /> : <div className="avatar-placeholder">?</div>}
                        <input type="file" accept="image/*" style={{ display: 'none' }} onChange={(e) => { const f = e.target.files?.[0]; if (f) uploadAvatar(person.id, f); e.target.value = ''; }} />
                      </label>
                      <div className="leadership-info">
                        <h3>{person.name}</h3>
                        {person.position && <p className="leadership-position">{person.position}</p>}
                        {person.bio && <p className="leadership-bio" style={{ maxWidth: 400 }}>{person.bio}</p>}
                      </div>
                    </div>
                    <div style={{ display: 'flex', gap: 8 }}>
                      <button type="button" className="glass-btn" onClick={() => openEditLeadership(person)}>Изменить</button>
                      <button type="button" className="glass-btn btn-danger" onClick={() => deleteLeadership(person.id)}>Удалить</button>
                    </div>
                  </div>
                ))}
              </div>
            </>
          )}
          {modal && (modal === 'add' || modal === 'edit') && (
            <div className="modal-overlay" onClick={() => setModal(null)}>
              <div className="modal" onClick={(e) => e.stopPropagation()}>
                <h2>{modal === 'add' ? 'Добавить сотрудника' : 'Редактировать'}</h2>
                <div className="form-group">
                  <label>Имя</label>
                  <input value={form.name} onChange={(e) => setForm({ ...form, name: e.target.value })} placeholder="ФИО или псевдоним" />
                </div>
                <div className="form-group">
                  <label>Должность</label>
                  <input value={form.position} onChange={(e) => setForm({ ...form, position: e.target.value })} placeholder="Должность" />
                </div>
                <div className="form-group">
                  <label>О сотруднике</label>
                  <textarea value={form.bio} onChange={(e) => setForm({ ...form, bio: e.target.value })} placeholder="Краткое описание" rows={3} />
                </div>
                <div className="form-group">
                  <label>Порядок (число)</label>
                  <input type="number" min={0} value={form.sort_order} onChange={(e) => setForm({ ...form, sort_order: parseInt(e.target.value, 10) || 0 })} />
                </div>
                {error && <p className="error-msg">{error}</p>}
                <div style={{ display: 'flex', gap: 8, marginTop: 16 }}>
                  <button type="button" className="glass-btn primary" onClick={saveLeadership} disabled={saving}>{saving ? 'Сохранение…' : 'Сохранить'}</button>
                  <button type="button" className="glass-btn" onClick={() => setModal(null)}>Отмена</button>
                </div>
              </div>
            </div>
          )}
        </div>
      );
    }

    function AdminRoute() {
      const { user, loading } = useAuth();
      if (loading) return <div className="public-layout" style={{ justifyContent: 'center' }}><p style={{ color: 'var(--text-muted)' }}>Загрузка…</p></div>;
      if (!user) return <AdminLogin />;
      return <AdminDashboard />;
    }

    function App() {
      return (
        <Routes>
          <Route path="/" element={<PublicLayout />}>
            <Route index element={<Home />} />
            <Route path="anketa" element={<Anketa />} />
            <Route path="company" element={<Company />} />
            <Route path="leadership" element={<Leadership />} />
          </Route>
          <Route path="/admin" element={<AdminRoute />} />
          <Route path="/login" element={<Navigate to="/admin" replace />} />
          <Route path="/register" element={<Navigate to="/" replace />} />
          <Route path="/administration" element={<Navigate to="/" replace />} />
          <Route path="/inactives" element={<Navigate to="/" replace />} />
          <Route path="/profile" element={<Navigate to="/" replace />} />
          <Route path="/admin-panel" element={<Navigate to="/admin" replace />} />
          <Route path="*" element={<Navigate to="/" replace />} />
        </Routes>
      );
    }

    // --- Mount ---
    createRoot(document.getElementById('root')).render(
      <React.StrictMode>
        <HashRouter>
          <AuthProvider>
            <App />
          </AuthProvider>
        </HashRouter>
      </React.StrictMode>
    );
  </script>
</body>
</html>
